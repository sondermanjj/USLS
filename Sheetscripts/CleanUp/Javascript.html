<script tpye="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://apis.google.com/js/api.js?onload=onApiLoad"></script>
<script>

  /*****************************************************************
      * @desc - Close the popup
      * @author - hendersonam
  *******************************************************************/
  function closePopup() {
    google.script.host.close();
  }
  
  /*****************************************************************
      * @desc - Handles the dropdown menu selections. If "New Sheet.." is selected,
      *         add an input box to type the name of the new sheet
      * @author - hendersonam
  *******************************************************************/
  $('.listOfSheets').change(function() { 
    var selectedValue = jQuery(this).val();
    switch(selectedValue){
      case 'New Sheet..':
        var parentId = this.parentElement.id;
        var input = $('<input>', {'type': 'text', id: parentId+'Input', 'class': 'newName'});
        input.insertAfter(this, null).insertBefore('.action input:eq(0)', null);        
        break;
      default:
        var parentId = this.parentElement.id;
        $("#"+parentId+"Input").remove();
        break;
    }
  });
  
  /*****************************************************************
      * @desc - On popup load, read in all the sheet names to be displayed
      *         in the dropdown menus
      * @author - hendersonam
  *******************************************************************/
  $(window).on('load', function() {
    showDiv("rawFilePrompt");
    google.script.run.withSuccessHandler(loadSheetNames).getListOfSheetNames();
  });
  
  /*****************************************************************
      * @desc - Load sheet names into the class for the dropdown menus
      * @param - names - Array - Array of sheet names in this spreadsheet
      * @author - hendersonam
  *******************************************************************/
  function loadSheetNames(names) {
    for(var i = 0; i < names.length; i++) {
      var option = $('<option>', {'class': names[i]+'Option', 'value': names[i], 'text': names[i]});
      $('.listOfSheets').append(option);
    }
    var option = document.createElement("option");
    option.text = "New Sheet..";
    $('.listOfSheets').append(option);
  }
  
  /*****************************************************************
      * @desc - Add the raw sheet to our properties and show the prompt
      *         for the student data sheet
      * @author - hendersonam
  *******************************************************************/
  function addRawSheet() {
    showDiv("studentDataPrompt");
  }
  
  /*****************************************************************
      * @desc - Changes the descriptionText of the prompts to appear 
                or dissapear.
      * @author - sondermanjj
  *******************************************************************/
  function toggleDescriptions() {
    if ($('#descriptionText').is(":visible")) {
      $('#descriptionText').hide();
    } else {
      $('#descriptionText').show();
    }    
  }
  
  /*****************************************************************
      * @desc - Add the student data sheet to our properties and show the prompt
      *         for the faculty data sheet
      * @author - hendersonam
  *******************************************************************/
  function addStudentDataSheet() {
    showDiv("facultyDataPrompt");
  }
  
  /*****************************************************************
      * @desc - Add the faculty data sheet to our properties and show the prompt
      *         for the dod list sheet
      * @author - hendersonam
  *******************************************************************/
  function addFacultyDataSheet() {
    showDiv("dodSheetPrompt");
  }
  
  /*****************************************************************
      * @desc - Add the dod list sheet to our properties and show the prompt
      *         for the faculty choices sheet
      * @author - hendersonam
  *******************************************************************/
  function addDODSheet() {
    showDiv("facultyChoicesPrompt");
  }
  
  /*****************************************************************
      * @desc - Add the faculty choices sheet to our properties and close the prompt
      * @author - hendersonam
  *******************************************************************/
  function addFacultyChoicesSheet() {
    $('#doneButton').prop("disabled", true);
    $('#finalBackButton').prop("disbaled", true);
    var rawSheetName = determineSheetName($('#rawFilePrompt'), $('#rawFilePrompt').children('.listOfSheets').val());
    var studentDataSheetName = determineSheetName($('#studentDataPrompt'), $('#studentDataPrompt').children('.listOfSheets').val());
    var facultyDataSheetName = determineSheetName($('#facultyDataPrompt'), $('#facultyDataPrompt').children('.listOfSheets').val());
    var dodSheetName = determineSheetName($('#dodSheetPrompt'), $('#dodSheetPrompt').children('.listOfSheets').val());
    var facultyChoicesSheetName = determineSheetName($('#facultyChoicesPrompt'), $('#facultyChoicesPrompt').children('.listOfSheets').val());
    
    var sheetNames = {raw: rawSheetName, student: studentDataSheetName, faculty:facultyDataSheetName,
                      dod: dodSheetName, choices: facultyChoicesSheetName};
                      
    google.script.run.withSuccessHandler(closePopup).initialization(sheetNames);
  }
  
  /*****************************************************************
      * @desc - Determins the sheet name. If listValue is New Sheet.., then figure
      *         figure out what the user typed. Otherwise, return the listValue as is
      * @params - parentDiv - HTMLElement - Parent of the select element. Used to get the
      *                                     User input if necessary
      *           listValue - String - Value of the select dropdown menu
      * @author - hendersonam
  *******************************************************************/
  function determineSheetName(parentDiv, listValue) {
    if(listValue == "New Sheet..") {
      return parentDiv.children('.newName').val();
    } else {
      return listValue;
    }
  }

  /*****************************************************************
      * @desc - Sets the display for the given divId to 'block' and all other divs to 'none'
      * @param - divID - String - the id of the div to toggle
      * @author - hendersonam
  *******************************************************************/
  function showDiv(divID) {
    var divs = document.getElementsByTagName('div');
    for(var i = 0; i < divs.length; i++){
      divs[i].style.display = 'none';
    }
    document.getElementById(divID).style.display = 'block';
  }


  /*****************************************************************
      * @desc - Sends the list of new courses to the backend logic
      *         to be added to the sheet
      * @author - hendersonam
  *******************************************************************/
  function getSheetNames() {
    var sheetNames = { studentData : $('#studentData').val(),
                      facultyData : $('#facultyData').val(),
                      dodList : $('#dodList').val(),
                      facultyChoices :  $('#facultyChoices').val(),
                      rawFileName : $('#rawFileName').val() };
                      
    google.script.run.withSuccessHandler(donee).validateSheets(sheetNames);
  }
  
</script>
